<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ุงูุญุณุงุจ - ุซุงูููุฉ ุงูุชุญุฏู</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
</head>
<body>
<div class="app">
  <!-- ุงูุจุงุฑ ุงูุนููู -->
  <header class="app-header">
    <h1>ุญุณุงุจ ุงูุทุงูุจ</h1>
    <p>ุนุฑุถ ูุชุนุฏูู ุงูุจูุงูุงุช ุงูุดุฎุตูุฉ ูุงููุงููุฉ</p>
  </header>

  <div class="card" id="accountCard">
    <!-- ูุณู ูุนูููุงุช ุงูุทุงูุจ -->
    <div class="section" id="infoSection">
      <h3>ูุนูููุงุช ุงูุทุงูุจ</h3>
      <div id="infoFields"></div>
    </div>

    <!-- ูุณู ุงููุนูููุงุช ุงููุงููุฉ -->
    <div class="section" id="financeSection">
      <h3>ุงููุนูููุงุช ุงููุงููุฉ</h3>
      <div id="financeFields"></div>
    </div>

    <button class="btn btn-primary" id="saveBtn">๐พ ุญูุธ ุงูุจูุงูุงุช ุงููุนุฏูุฉ</button>
    <button class="btn btn-logout" id="logoutBtn">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    <p id="statusMsg" style="text-align:center;margin-top:10px;"></p>
  </div>
</div>

<!-- ุงูุจุงุฑ ุงูุณููู -->
<nav class="bottom-nav">
  <a href="account.html" class="nav-item active">๐ค<span>ุงูุญุณุงุจ</span></a>
  <a href="grades.html" class="nav-item">๐<span>ุงูุฏุฑุฌุงุช</span></a>
  <a href="notifications.html" class="nav-item">๐<span>ุงูุชุจููุบุงุช</span></a>
  <a href="chat.html" class="nav-item">๐ฌ<span>ุงูุฏุฑุฏุดุฉ</span></a>
</nav>

<script>
const SHEET_API_URL = "YOUR_GOOGLE_SHEET_API_URL"; // ุถุน ุฑุงุจุท Google Apps Script ููุง

// ุฌูุณุฉ ุงููุณุชุฎุฏู
function getSession(){ return JSON.parse(sessionStorage.getItem('studentData')||'null'); }
function saveSession(obj){ sessionStorage.setItem('studentData', JSON.stringify(obj)); }
function requireLogin(){ if(!getSession()){ window.location.href='index.html'; return false;} return true; }

// ุฌูุจ ุงูุจูุงูุงุช ูู Google Sheet
async function fetchSheetData(){
  const resp = await fetch(SHEET_API_URL, {cache:"no-store"});
  if(!resp.ok) throw new Error("ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช ูู Google Sheets");
  return await resp.json();
}

// ุงูุจุญุซ ุญุณุจ ููู ุงูุฃูุฑ ูููุฏ ุงูุทุงูุจ
async function findByParentAndCode(parent, code){
  const data = await fetchSheetData();
  return data.find(r => r['ุฑูู ููู ุงูุงูุฑ'] == parent && r['ููุฏ ุงูุทุงูุจ'] == code);
}

// ุนุฑุถ ุงูุจูุงูุงุช ูู ุงูุตูุญุฉ
async function renderAccount(){
  if(!requireLogin()) return;
  gsap.to('#accountCard', {duration:0.7, opacity:1, y:0, ease:'power3.out'});

  const student = getSession();
  const infoFieldsContainer = document.getElementById('infoFields');
  const financeFieldsContainer = document.getElementById('financeFields');

  const editableFields = ['ุฑูู ุงูุทุงูุจ','ุฑูู ููู ุงูุงูุฑ','ุฑูู ุงูุฎุท','ุงููุฏุฑุณุฉ ุงููุงุฏู ูููุง','ุงูุนููุงู'];

  // ูุนูููุงุช ุงูุทุงูุจ
  const infoFields = ["id","ุงุณู ุงูุทุงูุจ","ุงูุตู","ุงููุงุนุฉ","ุงูุฌูุณ","ุฑูู ููู ุงูุงูุฑ","ุฑูู ุงูุฎุท","ุงูููุงุญุธุงุช","ููุฏ ุงูุทุงูุจ","ุฑูู ุงูุทุงูุจ","ุงููุชุจ","ุงูุนููุงู","ุงุณู ุงูุงู","ุงููุฏุฑุณุฉ ุงููุงุฏู ูููุง","ุงููุนุฏู"];
  infoFields.forEach(f=>{
    const val = student[f]||'';
    if(editableFields.includes(f)){
      infoFieldsContainer.innerHTML += `<label>${f}:<input type="text" id="${f}" value="${val}"/></label>`;
    } else {
      infoFieldsContainer.innerHTML += `<p><strong>${f}:</strong> ${val}</p>`;
    }
  });

  // ุงููุนูููุงุช ุงููุงููุฉ
  const financeFields = ["ุงููุณุท 1","ุชุงุฑูุฎ 1","ุงููุณุท 2","ุชุงุฑูุฎ 2","ุงููุณุท 3","ุชุงุฑูุฎ 3","ุงููุณุท 4","ุชุงุฑูุฎ 4","ุงููุณุท 5","ุชุงุฑูุฎ 5","ุงููุณุท 6","ุชุงุฑูุฎ 6","ุงููุณุท 7","ุชุงุฑูุฎ 7","ุงููุณุท 8","ุชุงุฑูุฎ 8","ุงูุจุงูู ุงูููู","ุงููุจูุบ ุงูููู","ุงููุงุตู ุงูููู","ุงูููุงูุฉ","ูุจูุบ ุงูููุงูุฉ"];
  financeFields.forEach(f=>{
    const val = student[f]||'';
    financeFieldsContainer.innerHTML += `<p><strong>${f}:</strong> ${val}</p>`;
  });

  // ุญูุธ ุงูุจูุงูุงุช ุงููุนุฏูุฉ
  document.getElementById('saveBtn').addEventListener('click', async ()=>{
    const updatedData = {...student};
    editableFields.forEach(f=> updatedData[f] = document.getElementById(f).value.trim());
    try{
      const resp = await fetch(SHEET_API_URL+"?action=update",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(updatedData)
      });
      const result = await resp.json();
      if(result.success){
        saveSession(updatedData);
        document.getElementById('statusMsg').textContent = 'โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ';
      } else {
        document.getElementById('statusMsg').textContent = 'โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช';
      }
    }catch(e){
      console.error(e);
      document.getElementById('statusMsg').textContent = 'โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุญูุธ';
    }
  });

  // ุชุณุฌูู ุงูุฎุฑูุฌ
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    sessionStorage.clear();
    window.location.href='index.html';
  });
}

// ุชููุฆุฉ ุงูุตูุญุฉ
document.addEventListener('DOMContentLoaded', renderAccount);
</script>
</body>
</html>
