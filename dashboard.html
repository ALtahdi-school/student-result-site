<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>لوحة الطالب - عرض البيانات</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
:root{--blue:#007bff;--green:#28a745;--danger:#dc3545}
*{box-sizing:border-box}
body{font-family:'Cairo',sans-serif;direction:rtl;margin:0;background:linear-gradient(180deg,#f8fbff,#ffffff);padding:18px}
.header{
  max-width:1200px;margin:0 auto 16px auto;display:flex;justify-content:space-between;align-items:center;gap:12px;
}
.brand{display:flex;flex-direction:column}
.brand h1{margin:0;font-size:20px}
.controls{display:flex;gap:8px;align-items:center}
.btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn-logout{background:#f0f0f0}
.container{
  max-width:1200px;margin:0 auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;
}

/* sections */
.section{
  background:#fff;border-radius:12px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,0.06);
  min-height:120px;
}
.section h3{margin:0 0 10px 0;padding:8px;border-radius:8px;color:#fff;background:linear-gradient(90deg,var(--blue),#0a73d9);font-size:15px;text-align:center}

/* financial */
.finance h3{background:linear-gradient(90deg,var(--green),#1f9b4d)}

/* grades */
.grades h3{background:linear-gradient(90deg,#ffc107,#f1c40f);color:#000}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:6px;border:1px solid #eee;text-align:right}
.small{font-size:13px;color:#666}

/* responsive */
@media (max-width:820px){ .header{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <h1>🎓 ثانوية التحدي — نظام الاستعلام</h1>
      <div class="small">عرض بيانات الطالب</div>
    </div>
    <div class="controls">
      <button class="btn btn-logout" id="logoutBtn">تسجيل خروج</button>
      <a href="index.html" class="btn" style="background:#fff;border:1px solid #eee">الصفحة الرئيسية</a>
    </div>
  </div>

  <div class="container" id="output">
    <!-- سيتم توليد المحتوى بالـ JavaScript -->
  </div>

<script>
/* يسترجع object الطالب من sessionStorage */
const stored = sessionStorage.getItem('studentData');
if(!stored){
  // لو لم يكن المستخدم قد سجل الدخول نعيده للصفحة الرئيسية
  alert('لم يتم تسجيل الدخول أو انتهت الجلسة. سيتم تحويلك إلى صفحة تسجيل الدخول.');
  window.location.href = 'index.html';
} else {
  const student = JSON.parse(stored);
  renderStudent(student);
}

function renderStudent(student){
  const out = document.getElementById('output');
  // normalize header keys might be different - but student object already contains fields as from sheet header
  function showTable(title, fields){
    let html = `<div class="section"><h3>${title}</h3><table>`;
    fields.forEach(f=>{
      const value = (student[f] !== undefined) ? student[f] : '';
      html += `<tr><th style="width:40%">${f}</th><td>${value}</td></tr>`;
    });
    html += `</table></div>`;
    return html;
  }

  // General fields attempt common alternatives
  const generalFields = ['اسم الطالب','اسم','اسم الطالب الكامل','الجنس','الصف','القاعة','رقم ولي الامر','رقم ولي الأمر','رقم الخط','id','كود الطالب','كود','الملاحظات'];
  // filter to only existing keys in student
  const presentGeneral = generalFields.filter(f=> student[f] !== undefined);
  // if none matched, create fallback showing all keys
  const genFieldsToShow = presentGeneral.length ? presentGeneral : Object.keys(student).slice(0,8);

  // المالية: pick common finance keys available
  const financeCandidates = ['القسط 1','تاريخ 1','القسط 2','تاريخ 2','القسط 3','تاريخ 3','الباقي الكلي','المبلغ الكلي','الواصل الكلي','مبلغ الكفالة','الكفالة'];
  const presentFinance = financeCandidates.filter(f => student[f] !== undefined);

  // درجات - subjects mapping simplified: سنظهر أي أعمدة تحتوي على أسماء أشهر أو 'الامتحان النهائي' ضمن الـ student
  const subjectBlocks = []; // each block: {title, cols}
  // detectable subjects by header name
  const possibleSubjects = ['الاسلامية','عربي','الانكليزي','الرياضيات','الكيمياء','الفيزياء','الاحياء','اجتماعيات','حاسوب','رياضة','فنية','السلوك'];
  possibleSubjects.forEach(sub=>{
    // find any key that matches column name like "شهر 1" but these are ambiguous.
    // We'll check for headers that include subject name OR headers that exactly match subject + space...
    const exists = Object.keys(student).some(k=> k.includes(sub) || k === sub);
    if(exists){
      // try to get columns relevant to subject (نفس التسمية في sheet): "شهر 1" etc.
      const cols = ['شهر 1','شهر 2','فصل 1','نصف سنة','شهر 3','شهر 4','فصل 2','الامتحان النهائي','السعي','التقدير']
        .filter(c => student[c] !== undefined || Object.keys(student).some(k=> k.includes(`${sub} ${c}`) || k.includes(`${sub}_${c}`)));
      subjectBlocks.push({title:sub, cols});
    }
  });

  // Fallback: if no subject blocks found, try to detect any columns that indicate grades
  if(subjectBlocks.length === 0){
    const gradeKeys = Object.keys(student).filter(k => /شهر|فصل|نصف|الامتحان|السعي|التقدير/i.test(k));
    // group them into one block
    if(gradeKeys.length) subjectBlocks.push({title:'الدرجات', cols: gradeKeys});
  }

  // Build HTML
  let html = '';
  html += showTable('المعلومات العامة', genFieldsToShow);
  if(presentFinance.length) html += showTable('المعلومات المالية', presentFinance);
  subjectBlocks.forEach(sb=>{
    let block = `<div class="section"><h3>الدرجات - ${sb.title}</h3><table><tr>`;
    // header row
    const cols = sb.cols.length ? sb.cols : Object.keys(student).filter(k=> /شهر|فصل|الامتحان|سعي|تقدير/i.test(k));
    cols.forEach(c => block += `<th>${c}</th>`);
    block += `</tr><tr>`;
    cols.forEach(c => {
      // if student has subject-specific column like "الرياضيات شهر 1", prefer that
      const specificKey = Object.keys(student).find(k => k === `${sb.title} ${c}` || k === `${sb.title}_${c}`) || c;
      block += `<td>${ student[specificKey] || '' }</td>`;
    });
    block += `</tr></table></div>`;
    html += block;
  });

  // notes
  const notesKeys = ['ملاحظات كرت','ملاحظات النتيجة','الغياب','اختلاق مشاكل داخل المدرسة','ملاحظات'];
  const presentNotes = notesKeys.filter(k=> student[k] !== undefined);
  if(presentNotes.length) html += showTable('ملاحظات وغياب', presentNotes);

  out.innerHTML = html;
}

/* تسجيل خروج */
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  if(confirm('هل تريد تسجيل الخروج؟')){
    sessionStorage.removeItem('studentData');
    window.location.href = 'index.html';
  }
});
</script>
</body>
</html>
