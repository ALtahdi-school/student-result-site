<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حساب الطالب</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<header>🎓 ثانوية التحدي الأهلية</header>

<div class="navbar">
  <a href="dashboard.html">🏠 الرئيسية</a>
  <a href="chat.html">💬 الدردشة</a>
  <a href="notifications.html">📢 التبليغات</a>
  <a href="#" onclick="logout()">🚪 تسجيل الخروج</a>
</div>

<div class="container" id="output"></div>

<script>
if(localStorage.getItem("loggedIn") !== "true") window.location.href="index.html";

const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vReghaYoMk3f8ffSBLRHIwZieEWCfk5Yx8W6c843TXkC6wpA78Z0X5nw21RRpxMdQ/pub?gid=1229272896&single=true&output=csv";

async function loadStudent(){
  const code = localStorage.getItem("studentCode");
  const parent = localStorage.getItem("parentNumber");
  const output = document.getElementById("output");
  output.innerHTML="<p style='text-align:center;'>⏳ جاري تحميل البيانات...</p>";
  try{
    const resp = await fetch(sheetURL);
    const text = await resp.text();
    const rows = text.split("\n").map(r=>r.split(","));
    const header = rows[0].map(h=>h.trim());
    const dataRows = rows.slice(1);
    const objects = dataRows.map(r=>{
      const obj={};
      for(let i=0;i<header.length;i++) obj[header[i]]=(r[i]||"").trim();
      return obj;
    });
    const student = objects.find(o=>o["كود الطالب"]===code && o["رقم ولي الامر"]===parent);
    if(!student){ output.innerHTML="<p style='color:red; text-align:center;'>❌ لم أجد بيانات.</p>"; return; }

    localStorage.setItem("studentClass", student["الصف"] || "");
    localStorage.setItem("studentName", student["اسم الطالب"] || "");

    let html="";
    const studentFields=["id","رقم الطالب","اسم الطالب","الجنس","الصف","القاعة","رقم ولي الامر","رقم الخط","الملاحظات"];
    html+=`<div class="section info"><h3>المعلومات العامة</h3><table>`;
    studentFields.forEach(f=>{ if(f in student) html+=`<tr><th>${f}</th><td>${student[f]}</td></tr>`; });
    html+="</table></div>";

    const financeFields=["القسط 1","تاريخ 1","القسط 2","تاريخ 2","القسط 3","تاريخ 3","الباقي الكلي","المبلغ الكلي"];
    html+=`<div class="section finance"><h3>المعلومات المالية</h3><table>`;
    financeFields.forEach(f=>{ if(f in student) html+=`<tr><th>${f}</th><td>${student[f]}</td></tr>`; });
    html+="</table></div>";

    const subjectsColumns = ["الاسلامية","عربي","الانكليزي","الرياضيات","الكيمياء","الفيزياء","الاحياء","اجتماعيات","حاسوب","رياضة","فنية","السلوك"];
    subjectsColumns.forEach(sub=>{
      html+=`<div class="section grades"><h3>الدرجات - ${sub}</h3><table><tr><th>تقدير</th><th>السعي</th><th>الامتحان النهائي</th></tr>`;
      html+=`<tr><td>${student["التقدير"]||""}</td><td>${student["السعي"]||""}</td><td>${student["الامتحان النهائي"]||""}</td></tr></table></div>`;
    });

    const noteFields=["ملاحظات كرت","ملاحظات النتيجة","الغياب","اختلاق مشاكل داخل المدرسة"];
    html+=`<div class="section notes"><h3>الملاحظات والغياب</h3><table>`;
    noteFields.forEach(f=>{ if(f in student) html+=`<tr><th>${f}</th><td>${student[f]}</td></tr>`; });
    html+="</table></div>";

    output.innerHTML = html;

  }catch(err){ console.error(err); output.innerHTML="<p style='color:red; text-align:center;'>❌ حدث خطأ.</p>"; }
}

function logout(){ localStorage.clear(); window.location.href="index.html"; }

loadStudent();
</script>

</body>
</html>
